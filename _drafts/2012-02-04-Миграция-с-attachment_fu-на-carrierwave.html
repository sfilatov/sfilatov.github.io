---
layout: post
title: "Миграция с attachment_fu на carrierwave"
date: '2012-02-04T05:00:00.000-08:00'
author: "Степан"
tags:
- attachment_fu to carrierwave
- Rails
- carrierwave
- ruby
- attachment_fu
modified_time: '2012-02-04T05:45:00.012-08:00'
blogger_id: tag:blogger.com,1999:blog-6563657311735677139.post-959075979982660082
---

В этой статье я хочу описать свой опыт миграции с одного решения для хранения файлов в Rails на другое. Приложение написанно на <span style="font-weight:bold;">Rails 2.3</span>. Миграция со старого плагина <a href="https://github.com/technoweenie/attachment_fu">attachment_fu</a> на библиотеку <a href="https://github.com/jnicklas/carrierwave">carrierwave</a>.<br /><br /><a href="https://github.com/technoweenie/attachment_fu">attachment_fu</a> не самое лучшее решение для хранения файлов, но так исторически сложилось, что используется в приложении именно оно и, в принципе работает, но есть несколько проблем:<br />1) Он больше не разрабатывается и не поддерживается, а значит не будут работать на новых версиях Ruby и Rails. Становиться невозможным переход всего приложения на rails 3.<br />2) Сама реализация плагина (по сравнению с <a href="https://github.com/jnicklas/carrierwave">carrierwave</a>) уступает в гибкости. Необходимо несколько колонок для хранения информации о файлe. Например для изображения с табнейлами (filename, content_type, size, width, height и вообще не нужная колонка parent_id!), тогда как carrierwave достаточно всего лишь колонки filename.<br />3) Каждое изображение, это отдельная модель в базе, таким образом на каждый тип аттачмента надо создавать новую модель, в carrierwave можно несколько аттачментов присоединять к одной модели.<br />4) Отсутствие поддержки новых бекендов для хранения.<br />5) Используются старые гемы для процессинга изображений.<br /><br /><a href="https://github.com/jnicklas/carrierwave">carrierwave</a> сейчас лучшее решение на просторах коммунити, в нем есть свои недочеты, но оно активно разрабатывается, и достаточно гибкое, чтобы вносить свои изменения, хаки, настройки. Весь код связанный с процессингом, и хранением файла описывается в так называемом uploader. Uploader может быть легко сконфигурирован под различные типы файлов. Также можно использовать один и тот же аплоудер для разных аттачментов.<br /><a href="https://github.com/thoughtbot/paperclip">paperclip</a> решил не использовать, по причине того, что он не достаточно гибкий, и самое главное требует дополнительных миграций в БД, так как тоже хранит метаинформацию в базе по своему. Миграции достаточно болезненная штука на больших базах, и может вызвать не нужную нагрузку. И по моему опыту допиливание <a href="https://github.com/thoughtbot/paperclip">paperclip</a> под свои нужды не такая уж и простая задача.<br />Для Rails 2.3.14 подходит carrierwave 4.10 (August 2010) (пруфлинк). Чтобы использовать последний carrierwave с собой придеться ташить специальный плагин и кучу всего(пруфлинк). Различия в интерфейсе между 4.10 и текущей версией(пруф) не значительный. Обновить потом carrierwave будет проще при переходе на rails 3.<br /><br />Готовое решение для миграции. Его нет, есть UploaderFu модуль и статья, но в них не описаны куча вопросов, как мигрировать базу и мигрировать ли её вообще. Куда аттачить uploader. Откуда брать ширину и высоту изображения. Работа с s3. Кропинг картинок.<br /><br />Какую колонку использовать для Carrierwave и почему.<br /><br />Как оставить в рабочем состоянии старые файлы и почему это будет работать.<br /><br />Получившийся UploaderFu. Обновленное решение.<br /><br />Валидация размера файла.<br /><br />Сохранение валидаций, который были в attachment_fu.<br /><br />Пример конкретного аплоудера с табнейлами и кропингом, получением ширины, высоты и размера файла.<br /><br />Миграция базы для текущей модели.<br /><br />Отчет о том, что это возможно не лучшее решение и не окончательное, но вполне рабочее.<br /><br />I18n для ошибок валидации.<br /><br /><br /><br /><br /><br /><br />