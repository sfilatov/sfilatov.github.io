---
layout: post
title: "Правильная отправка файлов в Rails"
date: '2011-02-17T02:01:00.000-08:00'
author: "Степан"
tags: 
modified_time: '2011-07-07T07:51:41.774-07:00'
blogger_id: tag:blogger.com,1999:blog-6563657311735677139.post-5705844337747070813
blogger_orig_url: http://sfilatov.blogspot.com/2011/02/rails.html
---

Отправлять файлы в ответ на запрос пользователя, через стандартный вызов <span style="font-style:italic;">send_file</span> - не лучшее решение. Если файл большой (примерно 200Mb), то рельсовый процесс, будь он запущен в <span style="font-style:italic;">apache</span> или <span style="font-style:italic;">nginx</span>, начинает простаивать отдавая файл пользователю. Пул потоков для обработки запросов всегда ограничен. Таким образом вместо того, чтобы быстро обработать запрос и освободить ресурсы, рельсовый поток будет отдавать содержимое огромного файла.<br /><br /><span style="font-weight:bold;">Решение простое Rails 2.3.*:</span><br />в методе <span style="font-style:italic;">send_file</span> - есть опция<span style="font-style:italic;"> :x_sendfile =&gt; true</span>. Правда эта опция работает только для <span style="font-style:italic;">apache</span> и <span style="font-style:italic;">lighttpd</span>. Она делает следующее: добавляет ссылку на файл в хедер ответа и все. Дальше файл отдает уже сам сервер.<br />В <span style="font-style:italic;">nginx</span> ссылка в хедере имеет немного другое название, и придется добавить папку содержащую файл в настройки <span style="font-style:italic;">nginx</span> в следующем виде:<br /><br /><span style="font-style:italic;">location /files {<br />          root /var/www;<br />          internal;<br />      }</span><br /><a href="http://kovyrin.net/2006/11/01/nginx-x-accel-redirect-php-rails/"> Подробнее для nginx</a><br /><br /><a href="http://www.therailsway.com/2009/2/22/file-downloads-done-right"> Подробне для apache и lightppd</a><br /><br />UPD: <span style="font-weight: bold;">Rails 3</span><br /><br />Настройки nginx:<br /><br /><script src="https://gist.github.com/1069666.js?file=nginx.conf"></script><br /><br /><br />Настройки Rails <span style="font-family:courier new;">файл production.rb</span><br /><br /><script src="https://gist.github.com/1069666.js?file=production.rb"></script>